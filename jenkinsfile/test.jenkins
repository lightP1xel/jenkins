#!groovy

properties([disableConcurrentBuilds()])

pipeline {
    agent any
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
        timestamps()
    }
    stages {
        stage('Check Docker Container status.') {
            steps {
                script {
                    def isContainerRunning = sh(
                        script: 'ssh root@192.168.200.106 "docker ps --filter "name=go_app" --format "{{.Names}}""',
                        returnStdout: true
                    ).trim()

                    env.CONTAINER_RUNNING = isContainerRunning == "go_app" ? "true" : "false"
                }
            }
        }

        stage('Run If Container Is Running.') {
            when {
                expression { return env.CONTAINER_RUNNING == "true" }
            }
            steps {
                echo 'Docker container is running. I will stop it now!'
                sh 'ssh root@192.168.200.106 \'docker stop go_app\''
            }
        }

        stage('Skip If Container Is Not Running.') {
            when {
                expression { return env.CONTAINER_RUNNING == "false" }
            }
            steps {
                echo 'Docker container is not running. I will skip this step!'
            }
        }

        stage("Build docker container.") {
            steps {
                sh 'ssh root@192.168.200.106 \'docker build --tag go /root/jenkins\''
            }
        }

        stage("Run docker container.") {
            steps {
                sh 'ssh root@192.168.200.106 \'docker run --rm --name go_app -p 8081:8080 -d go\''
            }
        }
    }
    post {
        success {
            withCredentials([string(credentialsId: 'botSecret', variable: 'TOKEN'), string(credentialsId: 'chatId', variable: 'CHAT_ID')]) {
                sh  ("""
                        curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage -d chat_id=${CHAT_ID} -d parse_mode=markdown -d text='*${env.JOB_NAME}* : POC *Branch*: ${env.GIT_BRANCH} *Build* : OK *Published* = YES'
        """)
        }
     }

        aborted {
        withCredentials([string(credentialsId: 'botSecret', variable: 'TOKEN'), string(credentialsId: 'chatId', variable: 'CHAT_ID')]) {
        sh  ("""
            curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage -d chat_id=${CHAT_ID} -d parse_mode=markdown -d text='*${env.JOB_NAME}* : POC *Branch*: ${env.GIT_BRANCH} *Build* : `Aborted` *Published* = `Aborted`'
        """)
        }

     }
     failure {
        withCredentials([string(credentialsId: 'botSecret', variable: 'TOKEN'), string(credentialsId: 'chatId', variable: 'CHAT_ID')]) {
        sh  ("""
            curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage -d chat_id=${CHAT_ID} -d parse_mode=markdown -d text='*${env.JOB_NAME}* : POC  *Branch*: ${env.GIT_BRANCH} *Build* : `not OK` *Published* = `no`'
        """)
        }
     }
    }
}